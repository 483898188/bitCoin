1. 查看连接状态

```shell
~/bitcoin/build/bin/bitcoin-cli -testnet -conf=$HOME/.bitcoin/testnet/bitcoin.conf getnetworkinfo

```



2. 添加可靠节点

```shell
~/bitcoin/build/bin/bitcoin-cli -testnet -conf=$HOME/.bitcoin/testnet/bitcoin.conf addnode 34.65.45.157 onetry
~/bitcoin/build/bin/bitcoin-cli -testnet -conf=$HOME/.bitcoin/testnet/bitcoin.conf addnode 34.13.143.255 onetry

```



3.  start_bitcoin_testnet.sh

```shell
#!/bin/bash

# =========================
# Bitcoin Testnet 启动 + 钱包 + 同步监控
# =========================

BITCOIN_BIN="$HOME/bitcoin/build/bin"
BITCOIND="$BITCOIN_BIN/bitcoind"
BITCOIN_CLI="$BITCOIN_BIN/bitcoin-cli"

# ------------------------
# 配置参数
# ------------------------
BITCOIN_CONF_DIR="$HOME/.bitcoin"
TESTNET_DIR="$BITCOIN_CONF_DIR/testnet"
CONF_FILE="$TESTNET_DIR/bitcoin.conf"
RPC_USER="bitcoinrpc"
RPC_PASSWORD="ChangeThisToAStrongPassword123!"
RPC_PORT=18332
WALLET_BASENAME=${1:-testwallet}   # 可传参数，否则默认 testwallet
WALLET_DIR="$TESTNET_DIR/wallets/$WALLET_BASENAME"

# ------------------------
# 检查 bitcoind
# ------------------------
if [ ! -x "$BITCOIND" ]; then
    echo "错误: 没找到 bitcoind，请确认目录: $BITCOIN_BIN"
    exit 1
fi

# ------------------------
# 停掉旧节点
# ------------------------
if pgrep -x "bitcoind" > /dev/null; then
    echo "停止旧节点..."
    pkill -9 bitcoind
    sleep 3
fi

# ------------------------
# 备份旧 testnet 数据
# ------------------------
if [ -d "$TESTNET_DIR" ]; then
    echo "检测到旧 testnet 数据，备份..."
    mv "$TESTNET_DIR" "${TESTNET_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
fi

# ------------------------
# 创建必要目录
# ------------------------
mkdir -p "$TESTNET_DIR/wallets"

# ------------------------
# 生成 testnet 配置文件到 datadir
# ------------------------
cat <<EOF > "$CONF_FILE"
# Bitcoin Core testnet 配置
testnet=1

[test]
rpcuser=$RPC_USER
rpcpassword=$RPC_PASSWORD
rpcport=$RPC_PORT
txindex=1
EOF

echo "生成配置文件: $CONF_FILE"

# ------------------------
# 启动节点
# ------------------------
echo "启动 Bitcoin testnet 节点..."
$BITCOIND -conf="$CONF_FILE" -datadir="$TESTNET_DIR" -daemon

# ------------------------
# 等待 RPC 可用
# ------------------------
echo "等待 RPC 可用..."
RETRY=0
until $BITCOIN_CLI -conf="$CONF_FILE" -datadir="$TESTNET_DIR" getblockcount >/dev/null 2>&1
do
    sleep 5
    RETRY=$((RETRY+1))
    echo -n "."
    if [ $RETRY -gt 60 ]; then
        echo
        echo "RPC 超时，请检查节点状态和磁盘空间"
        exit 1
    fi
done
echo
echo "RPC 已可用"

# ------------------------
# 钱包处理
# ------------------------
if [ -d "$WALLET_DIR" ]; then
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    WALLET_NAME="${WALLET_BASENAME}_${TIMESTAMP}"
    WALLET_DIR="$TESTNET_DIR/wallets/$WALLET_NAME"
    echo "检测到钱包 $WALLET_BASENAME 已存在，使用新钱包名: $WALLET_NAME"
else
    WALLET_NAME="$WALLET_BASENAME"
fi

echo "创建新钱包: $WALLET_NAME"
$BITCOIN_CLI -conf="$CONF_FILE" -datadir="$TESTNET_DIR" createwallet "$WALLET_NAME"

sleep 1

# ------------------------
# 生成新地址
# ------------------------
ADDRESS=$($BITCOIN_CLI -rpcwallet="$WALLET_NAME" -conf="$CONF_FILE" -datadir="$TESTNET_DIR" getnewaddress 2>/dev/null)
if [ -n "$ADDRESS" ]; then
    echo "你的 testnet 地址: $ADDRESS"
    echo "可用 faucet 获取测试币，例如：https://testnet-faucet.mempool.co/"
else
    echo "警告: 未能生成新地址，请检查钱包状态。"
fi

# ------------------------
# 区块同步监控循环
# ------------------------
echo "开始监控区块同步状态 (Ctrl+C 可停止)..."
while true; do
    INFO=$($BITCOIN_CLI -rpcwallet="$WALLET_NAME" -conf="$CONF_FILE" -datadir="$TESTNET_DIR" getblockchaininfo)
    BLOCKS=$(echo "$INFO" | grep -oP '"blocks":\s*\K\d+')
    HEADERS=$(echo "$INFO" | grep -oP '"headers":\s*\K\d+')
    IBD=$(echo "$INFO" | grep -oP '"initialblockdownload":\s*\K\w+')
    CONNECTIONS=$($BITCOIN_CLI -conf="$CONF_FILE" -datadir="$TESTNET_DIR" getnetworkinfo | grep -oP '"connections":\s*\K\d+')
    echo "$(date '+%H:%M:%S')  blocks=$BLOCKS  headers=$HEADERS  initialblockdownload=$IBD  connections=$CONNECTIONS"
    if [ "$IBD" = "false" ]; then
        echo "初始区块同步完成！"
        break
    fi
    sleep 60
done

```



4. 注意事项

   1. 节点软件安装

   2. 网络连接rpc

   3. 钱包功能(可能会存在已有钱包  新建钱包解决）

      

5. 清理

   ```shell
   # 清理整个testnet节点
   rm -rf ~/.bitcoin/testnet
   
   # 清理配置
   rm -f ~/.bitcoin/bitcoin.conf
   
   ```

   

6. rpc问题

```shell
# 配置文件中 [test]块必须存在

# 服务启动版本号问题


```



7. 如果要启用上一次数据

```shell
#!/bin/bash

# =========================
# Bitcoin Testnet 启动 + 钱包 + 同步监控 (复用上次数据)
# =========================

BITCOIN_BIN="$HOME/bitcoin/build/bin"
BITCOIND="$BITCOIN_BIN/bitcoind"
BITCOIN_CLI="$BITCOIN_BIN/bitcoin-cli"

# ------------------------
# 配置参数
# ------------------------
BITCOIN_CONF_DIR="$HOME/.bitcoin"
TESTNET_DIR="$BITCOIN_CONF_DIR/testnet"
CONF_FILE="$TESTNET_DIR/bitcoin.conf"
RPC_USER="bitcoinrpc"
RPC_PASSWORD="ChangeThisToAStrongPassword123!"
RPC_PORT=18332
WALLET_BASENAME=${1:-testwallet}   # 可传参数，否则默认 testwallet
WALLET_DIR="$TESTNET_DIR/wallets/$WALLET_BASENAME"

# ------------------------
# 检查 bitcoind
# ------------------------
if [ ! -x "$BITCOIND" ]; then
    echo "错误: 没找到 bitcoind，请确认目录: $BITCOIN_BIN"
    exit 1
fi

# ------------------------
# 停掉旧节点
# ------------------------
if pgrep -x "bitcoind" > /dev/null; then
    echo "停止旧节点..."
    pkill -9 bitcoind
    sleep 3
fi

# ------------------------
# 创建 testnet 数据目录（如果不存在）
# ------------------------
if [ ! -d "$TESTNET_DIR" ]; then
    echo "首次启动，创建 testnet 数据目录..."
    mkdir -p "$TESTNET_DIR/wallets"
    NEW_TESTNET=1
else
    echo "检测到已有 testnet 数据，直接使用上一次数据"
    mkdir -p "$TESTNET_DIR/wallets"
    NEW_TESTNET=0
fi

# ------------------------
# 生成配置文件到 datadir（首次启动才生成）
# ------------------------
if [ $NEW_TESTNET -eq 1 ] || [ ! -f "$CONF_FILE" ]; then
cat <<EOF > "$CONF_FILE"
# Bitcoin Core testnet 配置
testnet=1

[test]
rpcuser=$RPC_USER
rpcpassword=$RPC_PASSWORD
rpcport=$RPC_PORT
txindex=1
EOF
    echo "生成配置文件: $CONF_FILE"
else
    echo "使用已有配置文件: $CONF_FILE"
fi

# ------------------------
# 启动节点
# ------------------------
echo "启动 Bitcoin testnet 节点..."
$BITCOIND -conf="$CONF_FILE" -datadir="$TESTNET_DIR" -daemon

# ------------------------
# 等待 RPC 可用
# ------------------------
echo "等待 RPC 可用..."
RETRY=0
until $BITCOIN_CLI -conf="$CONF_FILE" -datadir="$TESTNET_DIR" getblockcount >/dev/null 2>&1
do
    sleep 5
    RETRY=$((RETRY+1))
    echo -n "."
    if [ $RETRY -gt 60 ]; then
        echo
        echo "RPC 超时，请检查节点状态和磁盘空间"
        exit 1
    fi
done
echo
echo "RPC 已可用"

# ------------------------
# 钱包处理
# ------------------------
LOADED_WALLETS=$($BITCOIN_CLI -conf="$CONF_FILE" -datadir="$TESTNET_DIR" listwallets)

if echo "$LOADED_WALLETS" | grep -q "\"$WALLET_BASENAME\""; then
    echo "钱包 $WALLET_BASENAME 已加载"
    WALLET_NAME="$WALLET_BASENAME"
elif [ -d "$TESTNET_DIR/wallets/$WALLET_BASENAME" ]; then
    echo "钱包 $WALLET_BASENAME 已存在但未加载，加载钱包..."
    $BITCOIN_CLI -conf="$CONF_FILE" -datadir="$TESTNET_DIR" loadwallet "$WALLET_BASENAME"
    WALLET_NAME="$WALLET_BASENAME"
else
    echo "创建新钱包: $WALLET_BASENAME"
    $BITCOIN_CLI -conf="$CONF_FILE" -datadir="$TESTNET_DIR" createwallet "$WALLET_BASENAME"
    WALLET_NAME="$WALLET_BASENAME"
fi

sleep 1

# ------------------------
# 生成新地址
# ------------------------
ADDRESS=$($BITCOIN_CLI -rpcwallet="$WALLET_NAME" -conf="$CONF_FILE" -datadir="$TESTNET_DIR" getnewaddress 2>/dev/null)
if [ -n "$ADDRESS" ]; then
    echo "你的 testnet 地址: $ADDRESS"
    echo "可用 faucet 获取测试币，例如：https://testnet-faucet.mempool.co/"
else
    echo "警告: 未能生成新地址，请检查钱包状态。"
fi

# ------------------------
# 区块同步监控循环
# ------------------------
echo "开始监控区块同步状态 (Ctrl+C 可停止)..."
while true; do
    INFO=$($BITCOIN_CLI -rpcwallet="$WALLET_NAME" -conf="$CONF_FILE" -datadir="$TESTNET_DIR" getblockchaininfo)
    BLOCKS=$(echo "$INFO" | grep -oP '"blocks":\s*\K\d+')
    HEADERS=$(echo "$INFO" | grep -oP '"headers":\s*\K\d+')
    IBD=$(echo "$INFO" | grep -oP '"initialblockdownload":\s*\K\w+')
    CONNECTIONS=$($BITCOIN_CLI -conf="$CONF_FILE" -datadir="$TESTNET_DIR" getnetworkinfo | grep -oP '"connections":\s*\K\d+')
    echo "$(date '+%H:%M:%S')  blocks=$BLOCKS  headers=$HEADERS  initialblockdownload=$IBD  connections=$CONNECTIONS"
    if [ "$IBD" = "false" ]; then
        echo "初始区块同步完成！"
        break
    fi
    sleep 60
done

```

